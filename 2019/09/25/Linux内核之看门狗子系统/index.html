<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Code controls all the hardware"><title>Linux内核之看门狗子系统 | Evil Code</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Linux内核之看门狗子系统</h1><a id="logo" href="/.">Evil Code</a><p class="description">Coding Change The World</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Linux内核之看门狗子系统</h1><div class="post-meta">Sep 25, 2019<span> | </span><span class="category"><a href="/categories/Kernel/">Kernel</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#看门狗子系统核心"><span class="toc-number">2.</span> <span class="toc-text">看门狗子系统核心</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#看门狗子系统入口"><span class="toc-number">2.1.</span> <span class="toc-text">看门狗子系统入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#抽象设备的初始化"><span class="toc-number">2.2.</span> <span class="toc-text">抽象设备的初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#看门狗设备驱动注册接口"><span class="toc-number">2.3.</span> <span class="toc-text">看门狗设备驱动注册接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注册接口"><span class="toc-number">2.3.1.</span> <span class="toc-text">注册接口</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据结构"><span class="toc-number">2.3.2.</span> <span class="toc-text">数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注册过程"><span class="toc-number">2.3.3.</span> <span class="toc-text">注册过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#抽象设备接口"><span class="toc-number">2.3.4.</span> <span class="toc-text">抽象设备接口</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#看门狗设备驱动"><span class="toc-number">3.</span> <span class="toc-text">看门狗设备驱动</span></a></li></ol></div></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>​    linux看门狗子系统由其核心层和设备驱动构成，看门狗核心层向下为看门狗设备提供了注册和注销等接口，向上注册了一个通用的看门狗设备驱动（字符设备或杂项设备），该设备作为看门狗的抽象，屏蔽了不同看门狗设备的硬件操作之差异，向linux应用层提供了统一的读写和设置等通用接口。</p>
<h2 id="看门狗子系统核心"><a href="#看门狗子系统核心" class="headerlink" title="看门狗子系统核心"></a>看门狗子系统核心</h2><h3 id="看门狗子系统入口"><a href="#看门狗子系统入口" class="headerlink" title="看门狗子系统入口"></a>看门狗子系统入口</h3><p>​    看门狗核心层初始化代码在drivers/watchdog/watchdog_core.c中，其初始化函数为watchdog_init，该函数由subsys_initcall_sync宏设置为子系统初始化函数，在linux内核子系统初始化阶段调用。在内核中该代码片段如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subsys_initcall_sync(watchdog_init);</span><br></pre></td></tr></table></figure>
<p>​    在watchdog_init函数中通过调用watchdog_dev_init完成抽象看门狗设备的初始化，紧接着通过watchdog_deferred_registration()函数将推迟注册的看门狗设备注册到看门狗子系统核心。在这里推迟注册的设备指的是在看门狗子系统初始化之前的注册请求，这些设备在注册的时候看门狗核心还未初始化，因此将这些注册请求放入一个链表，在子系统初始化的时候遍历该链表并注册之。以下是内核中看门狗初始化的函数的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">watchdog_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">	err = watchdog_dev_init();</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	watchdog_deferred_registration();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="抽象设备的初始化"><a href="#抽象设备的初始化" class="headerlink" title="抽象设备的初始化"></a>抽象设备的初始化</h3><p>​    抽象设备是看门狗子系统最核心的一部分，其初始化相当简洁，主要分为三个步骤，第一是申请工作队列，该工作队列主要用于看门狗ping操作。第二步注册看门狗class，第三步调用alloc_chrdev_region为看门狗设备分配主设备号。</p>
<p>​    至此，看门狗子系统的初始化工作完成，其余工作为看门狗设备驱动的注册和应用层对看门狗的操作。</p>
<h3 id="看门狗设备驱动注册接口"><a href="#看门狗设备驱动注册接口" class="headerlink" title="看门狗设备驱动注册接口"></a>看门狗设备驱动注册接口</h3><h4 id="注册接口"><a href="#注册接口" class="headerlink" title="注册接口"></a>注册接口</h4><p>看门狗子系统向设备驱动提供了以下两种注册接口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPORT_SYMBOL_GPL(devm_watchdog_register_device);</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPORT_SYMBOL_GPL(watchdog_register_device);</span><br></pre></td></tr></table></figure>
<p>devm_watchdog_register_device接口比watchdog_register_device接口多了资源管理功能，在驱动卸载时会自动调用注销接口watchdog_unregister_device，而不需要驱动程序显示调用。在这里重点关注watchdog_register_device函数。</p>
<p>在watchdog_register_device函数中首先判断看门狗子系统是否初始化，已经初始化则继续注册，否则将要注册的设备驱动加入延迟注册链表，等待看门狗子系统初始化完成后注册之。该函数在内核中的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">watchdog_register_device</span><span class="params">(struct watchdog_device *wdd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;wtd_deferred_reg_mutex);</span><br><span class="line">	<span class="keyword">if</span> (wtd_deferred_reg_done)</span><br><span class="line">		ret = __watchdog_register_device(wdd);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		ret = watchdog_deferred_registration_add(wdd);</span><br><span class="line">	mutex_unlock(&amp;wtd_deferred_reg_mutex);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><p>看门狗子系统用struct watchdog_device类型的结构表示一个看门狗设备。该结构在内核中的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watchdog_device</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> **<span class="title">groups</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchdog_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchdog_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">watchdog_governor</span> *<span class="title">gov</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> bootstatus;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> timeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> pretimeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_timeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_timeout;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min_hw_heartbeat_ms;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> max_hw_heartbeat_ms;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">notifier_block</span> <span class="title">reboot_nb</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">notifier_block</span> <span class="title">restart_nb</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *driver_data;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watchdog_core_data</span> *<span class="title">wd_data</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> status;</span><br><span class="line"><span class="comment">/* Bit numbers for status flags */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WDOG_ACTIVE		0	<span class="comment">/* Is the watchdog running/active */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WDOG_NO_WAY_OUT		1	<span class="comment">/* Is 'nowayout' feature set ? */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WDOG_STOP_ON_REBOOT	2	<span class="comment">/* Should be stopped on reboot */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WDOG_HW_RUNNING		3	<span class="comment">/* True if HW watchdog running */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">deferred</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>几个重要的成员说明如下：</p>
<p>id：设备编号，主要用作字符设备从设备号，不需要设置，向看门狗子系统在注册设备时自动设置。</p>
<p>info：看门狗信息结构，描述看门狗版本标识和选项，选项主要用来表示该设备驱动支持的操作。</p>
<p>ops：看门狗操作函数，看门狗子系统支持的函数列表在内核中的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">watchdog_ops</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">	<span class="comment">/* mandatory operations */</span></span><br><span class="line">	<span class="keyword">int</span> (*start)(struct watchdog_device *);</span><br><span class="line">	<span class="keyword">int</span> (*stop)(struct watchdog_device *);</span><br><span class="line">	<span class="comment">/* optional operations */</span></span><br><span class="line">	<span class="keyword">int</span> (*ping)(struct watchdog_device *);</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*status)</span><span class="params">(struct watchdog_device *)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*set_timeout)(struct watchdog_device *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="keyword">int</span> (*set_pretimeout)(struct watchdog_device *, <span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">	<span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*get_timeleft)</span><span class="params">(struct watchdog_device *)</span></span>;</span><br><span class="line">	<span class="keyword">int</span> (*restart)(struct watchdog_device *, <span class="keyword">unsigned</span> <span class="keyword">long</span>, <span class="keyword">void</span> *);</span><br><span class="line">	<span class="keyword">long</span> (*ioctl)(struct watchdog_device *, <span class="keyword">unsigned</span> <span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>timeout：看门狗复位时间</p>
<p>min_timeout：看门狗支持的最小复位时间</p>
<p>max_timeout：看门狗支持的最大复位时间</p>
<p>reboot_nb：看门狗复位通知块，系统重启时回调其处理函数</p>
<p>restart_nb：看门狗重启通知块，收到系统重启看门狗指令时执行其处理函数</p>
<p>status：看门狗状态</p>
<h4 id="注册过程"><a href="#注册过程" class="headerlink" title="注册过程"></a>注册过程</h4><p>看门狗在注册的时候传入其watchdog_device结构体首地址，在看门狗子系统核心层提供的注册接口中首先会对其进行合法检查，必须实现start函数和stop函数（当max_hw_heartbeat_ms不为零时），以及最小复位时间不能大于当前喂狗时间等。紧接着为其分配从设备id，然后通过执行watchdog_dev_register函数注册该设备，在watchdog_dev_register函数中为设备申请了struct watchdog_core_data类型的结构，该结构用于描述抽象看门狗设备。其wdd成员被赋值为要注册的看门狗设备结构。然后向系统注册了字符设备，该字符设备绑定了统一的抽象设备文件操作接口watchdog_fops，该结构在内核中的初始化代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">watchdog_fops</span> = &#123;</span></span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.write		= watchdog_write,</span><br><span class="line">	.unlocked_ioctl	= watchdog_ioctl,</span><br><span class="line">	.open		= watchdog_open,</span><br><span class="line">	.release	= watchdog_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>至此设备驱动注册主要功能已经完成，剩余工作还有创建组，注册预超时，注册通知连等。</p>
<h4 id="抽象设备接口"><a href="#抽象设备接口" class="headerlink" title="抽象设备接口"></a>抽象设备接口</h4><p><strong>watchdog_open：</strong></p>
<p>watchdog_open函数在用户空间调用open系统调用的时候执行。该函数首先用container_of宏通过inode-&gt;i_cdev中取出注册时设置的抽象设备结构wd_data，然后判断看门狗是否已经被打开，如果已经打开则向用户空间返回-EBUSY。否作从wd_data中取出看门狗设备结构wdd，该结构在看门狗设备注册的时候赋值给wd_data的wdd成员。</p>
<p>接下来的操作就是通过wdd的ops成员实际调用设备驱动的操作函数对设备进行操作。在open函数中调用的看门狗设备的操作函数为start函数或ping函数（如果已经在运行）。在完成看门狗设备的start调用后将抽象设备结构赋值给file指针的private_data成员，以供write和ioctl接口使用。</p>
<p><strong>watchdog_write：</strong></p>
<p>watchdog_write函数在用户空间调用write系统调用的时候执行。该函数首先从file结构中获取到抽象设备数据结构wd_data（在open的时候赋值给file结构的private_data成员）。然后在wd_data结构中取出看门狗设备驱动数据结构wdd，然后执行wdd中的操作函数结构中的ping函数或start函数（如果没有ping函数实现）。</p>
<p><strong>watchdog_ioctl：</strong></p>
<p>watchdog_ioctl函数在用户空间调用ioctl系统调用的时候执行，用来设置和获取看门狗参数或直接操作看门狗。其中哪些选项支持由具体的看门狗设备驱动中info成员的options成员决定</p>
<h2 id="看门狗设备驱动"><a href="#看门狗设备驱动" class="headerlink" title="看门狗设备驱动"></a>看门狗设备驱动</h2><p>有了看门狗核心层提供的抽象和机制，看门狗设备驱动也比较统一和简洁，下面以ti看门狗驱动omap-wdt为例，结合看门狗子系统框架说明一个看门狗设备驱动的实现过程。</p>
<p>1.申请或定义struct watchdog_device结构，该结构描述在看门狗核心层用来描述一个看门狗设备。</p>
<p>在omap-wdt中该结构定义在omap_wdt_dev结构中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">omap_wdt_dev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">watchdog_device</span> <span class="title">wdog</span>;</span></span><br><span class="line">	<span class="keyword">void</span> __iomem    *base;          <span class="comment">/* physical */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>   *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="keyword">bool</span>		omap_wdt_users;</span><br><span class="line">	<span class="keyword">int</span>		wdt_trgr_pattern;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>	<span class="title">lock</span>;</span>		<span class="comment">/* to avoid races with PM */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>2.设置struct watchdog_device结构，主要是对watchdog_device结构做初始化。</p>
<p>在omap-wdt中一些设置代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wdev-&gt;wdog.info = &amp;omap_wdt_info;</span><br><span class="line">wdev-&gt;wdog.ops = &amp;omap_wdt_ops;</span><br><span class="line">wdev-&gt;wdog.min_timeout = TIMER_MARGIN_MIN;</span><br><span class="line">wdev-&gt;wdog.max_timeout = TIMER_MARGIN_MAX;</span><br><span class="line">wdev-&gt;wdog.parent = &amp;pdev-&gt;dev;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>3.实现硬件相关的操作，主要实现watchdog_device结构中的ops成员。</p>
<p>在omap-wdt中该成员初始化如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">static const struct watchdog_ops omap_wdt_ops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.start		= omap_wdt_start,</span><br><span class="line">	.stop		= omap_wdt_stop,</span><br><span class="line">	.ping		= omap_wdt_ping,</span><br><span class="line">	.set_timeout	= omap_wdt_set_timeout,</span><br><span class="line">	.get_timeleft	= omap_wdt_get_timeleft,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的操作函数在用户空间操作看门狗设备时由看门狗核心层根据用户操作回调。这些接口主要涉及的是看门狗的寄存器操作。</p>
<p>4.注册看门狗设备，向看门狗核心层注册watchdog_device</p>
<p>在omap-wdt中注册代码片段如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = watchdog_register_device(&amp;wdev-&gt;wdog);</span><br><span class="line">if (ret) &#123;</span><br><span class="line">	pm_runtime_disable(wdev-&gt;dev);</span><br><span class="line">	return ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Linux/">Linux</a><a href="/tags/kernel/">kernel</a><a href="/tags/watchdog/">watchdog</a></div><div class="post-nav"><a class="pre" href="/2019/11/26/ARM-LINUX中断系统/">ARM-LINUX中断系统</a><a class="next" href="/2019/09/24/Linux内核之虚拟文件系统/">Linux内核之虚拟文件系统</a></div><div id="container"></div><link rel="stylesheet" href="/css/default.css?v=0.0.0"><script src="/js/gitment.browser.js?v=0.0.0"></script><script>var gitment = new Gitment({
  id: window.location.pathname.substring(1,window.location.pathname.length),
  owner: 'geekchenxd',
  repo: 'geekchenxd.github.io',
  oauth: {
    client_id: '00f3259791ebc5b5d412',
    client_secret: 'd88056bc0050337d5767e26f8d228f526ed7687d',
  },
})
gitment.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://www.chenxd.xyz"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kernel/">Kernel</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/watchdog/" style="font-size: 15px;">watchdog</a> <a href="/tags/subsystem/" style="font-size: 15px;">subsystem</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/initcall/" style="font-size: 15px;">initcall</a> <a href="/tags/dtb/" style="font-size: 15px;">dtb</a> <a href="/tags/dts/" style="font-size: 15px;">dts</a> <a href="/tags/file-system/" style="font-size: 15px;">file_system</a> <a href="/tags/Interrupt/" style="font-size: 15px;">Interrupt</a> <a href="/tags/usb/" style="font-size: 15px;">usb</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/11/26/ARM-LINUX中断系统/">ARM-LINUX中断系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/25/Linux内核之看门狗子系统/">Linux内核之看门狗子系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/24/Linux内核之虚拟文件系统/">Linux内核之虚拟文件系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/28/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/09/Linux内核usb子系统/">Linux内核usb子系统</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/09/Linux内核initcall过程/">Linux内核initcall过程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/09/ARM-Linux设备树/">ARM-Linux设备树</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/Docker使用小记/">Docker使用小记</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.github.com" title="github" target="_blank">github</a><ul></ul><a href="http://www.kernel.org" title="linux kernel" target="_blank">linux kernel</a><ul></ul><a href="http://www.combatpress.com/" title="Combat Press" target="_blank">Combat Press</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Evil Code.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.2/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>